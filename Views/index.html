<!DOCTYPE html>
<html lang="en">
<head>
<style>
body.dark-mode { background: #181a1b !important; color: #e0e0e0 !important; }
.container, .navbar, .nav { background: #23272a !important; color: #e0e0e0 !important; }
input, textarea, button { background: #222 !important; color: #e0e0e0 !important; border-color: #444 !important; }
</style>
<style>
body.dark-mode { background: #111; color: #eee; }
.navbar, .nav { background: #222 !important; color: #eee !important; }
button, input, textarea { background: #222; color: #eee; border: 1px solid #444; }
</style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HFCA Group Chat</title>
  <meta name="description" content="HFCA Group Chat - A place for Dr. Howard Fuller Collegiate Academy students to chat and connect." />
  <meta name="keywords" content="HFCA, group chat, Howard Fuller, Collegiate Academy, student chat, dashboard, schedule, profile" />
  <meta property="og:title" content="HFCA Group Chat" />
  <meta property="og:description" content="A place for Dr. Howard Fuller Collegiate Academy students to chat and connect." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://yourdomain.com/" />
  <meta property="og:site_name" content="HFCA Group Chat" />
</head>
<body>
<div id="role-indicator" style="position:fixed;top:16px;left:24px;z-index:1000;display:flex;align-items:center;gap:8px;font-size:1.1em;"></div>
<div style="position:fixed;top:16px;right:24px;z-index:1000;">
  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
    <input type="checkbox" id="dark-mode-toggle" style="transform:scale(1.2);"> Dark Mode
  </label>
</div>
  <nav style="width:100%;background:#222;padding:16px 0 12px 0;position:fixed;top:0;left:0;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;">
      <a href="/index.html" style="color:#fff;text-decoration:none;font-size:1.2em;font-weight:bold;margin-right:32px;">Dashboard</a>
      <a href="/schedule.html" style="color:#fff;text-decoration:none;font-size:1.1em;margin-right:32px;">Schedule</a>
      <a href="/profile-settings.html" style="color:#fff;text-decoration:none;font-size:1.1em;">Profile</a>
      <div id="recent-dms-nav" style="position:relative;margin-left:32px;">
        <button id="recent-dms-btn" style="background:none;border:none;color:#fff;font-size:1.1em;cursor:pointer;">Recent DMs</button>
        <div id="recent-dms-dropdown" style="display:none;position:absolute;top:36px;right:0;min-width:260px;background:#fff;color:#222;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.18);z-index:9999;padding:8px 0;max-height:320px;overflow-y:auto;"></div>
      </div>
      <button id="settings-btn" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.1em; cursor:pointer;">‚öôÔ∏è Settings</button>
      <div id="nav-avatar-link" style="margin-left:18px;display:flex;align-items:center;position:relative;cursor:pointer;">
        <img id="nav-avatar" src="https://ui-avatars.com/api/?name=User&background=007bff&color=fff&rounded=true&size=40" alt="Profile" style="width:38px;height:38px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.10);object-fit:cover;transition:border-color 0.2s;">
        <div id="avatar-dropdown" style="display:none;position:absolute;top:48px;right:0;min-width:180px;background:#fff;color:#222;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.18);z-index:9999;padding:8px 0;">
          <a href="/profile-settings.html" style="display:block;padding:10px 24px;text-decoration:none;color:#222;font-size:1em;">Profile</a>
          <div style="height:1px;background:#eee;margin:4px 0;"></div>
          <button id="dropdown-settings-btn" style="display:block;width:100%;text-align:left;padding:10px 24px;background:none;border:none;color:#222;font-size:1em;cursor:pointer;">Settings</button>
          <button id="dropdown-darkmode-btn" style="display:flex;align-items:center;gap:8px;width:100%;text-align:left;padding:10px 24px;background:none;border:none;color:#222;font-size:1em;cursor:pointer;">
            <span>Dark Mode</span>
            <input type="checkbox" id="dropdown-darkmode-toggle" style="transform:scale(1.2);margin-left:auto;">
          </button>
          <button id="dropdown-logout-btn" style="display:block;width:100%;text-align:left;padding:10px 24px;background:none;border:none;color:#d00;font-size:1em;cursor:pointer;">Log Out</button>
          <button id="dropdown-view-reports-btn" style="display:none;width:100%;text-align:left;padding:10px 24px;background:none;border:none;color:#007bff;font-size:1em;cursor:pointer;">View Reports</button>
        </div>
      </div>
    </div>
  </nav>
  <!-- Profile Settings Modals -->
        </div>
      </div>
    </div>
  </nav>
  <div style="height:64px;"></div>
  <h1 style="text-align:center; margin-top:0; color:#333; font-family:Arial, sans-serif;">Group Chat</h1>
  <div id="settings-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; padding:32px; border-radius:8px; min-width:300px; max-width:90vw; box-shadow:0 2px 16px rgba(0,0,0,0.2); position:relative;">
      <button id="close-settings" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.3em; cursor:pointer;">‚úñÔ∏è</button>
      <h2 style="margin-top:0;">Settings</h2>
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
        <input type="checkbox" id="dark-mode-toggle" style="transform:scale(1.3);"> Dark Mode
      </label>
    </div>
  </div>
  <div style="max-width:500px; margin:32px auto 0 auto; background:#fff; padding:32px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; flex-direction:column; min-height:400px;">
    <div id="messages" style="flex:1 1 auto; min-height:120px; border-top:1px solid #eee; padding-top:16px; margin-bottom:24px;"></div>
    <div style="flex-shrink:0;">
      <button id="open-text-box" style="width:100%; padding:12px; background:#007bff; color:#fff; border:none; border-radius:4px; font-size:16px; cursor:pointer;">Text</button>
      <form id="text-form" style="display:none; margin-top:16px;">
        <label for="message" style="display:block; margin-bottom:8px; color:#555; font-size:1.1em;">Enter your message:</label>
        <textarea id="message" name="message" rows="3" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:1em;"></textarea>
        <button type="submit" style="margin-top:16px; width:100%; padding:12px; background:#007bff; color:#fff; border:none; border-radius:4px; font-size:16px; cursor:pointer;">Send</button>
        <div id="text-status" style="margin-top:12px; color:#007bff; text-align:center;"></div>
      </form>
    </div>
  </div>
  <script>
// Role icon logic
function getRoleIcon(role) {
  if (role === 'administrator') return 'üõ°Ô∏è';
  return 'üéì';
}
function showRoleIndicator() {
  // Example: get username and role from localStorage or session
  let username = localStorage.getItem('username') || 'user';
  let role = 'student';
  if (username === 'dev') role = 'administrator';
  if (username === 'Christopher Harston') role = 'student';
  const indicator = document.getElementById('role-indicator');
  if (indicator) indicator.innerHTML = getRoleIcon(role) + ' ' + role.charAt(0).toUpperCase() + role.slice(1);
}
showRoleIndicator();
// Dark mode logic
function applyDarkMode() {
  const enabled = localStorage.getItem('darkMode') === 'true';
  document.body.classList.toggle('dark-mode', enabled);
  const toggle = document.getElementById('dark-mode-toggle');
  if (toggle) toggle.checked = enabled;
}
applyDarkMode();
document.getElementById('dark-mode-toggle').onchange = function(e) {
  localStorage.setItem('darkMode', e.target.checked ? 'true' : 'false');
  applyDarkMode();
};
window.addEventListener('storage', function(e) {
  if (e.key === 'darkMode') applyDarkMode();
});
function applyDarkMode() {
  const enabled = localStorage.getItem('darkMode') === 'true';
  document.body.classList.toggle('dark-mode', enabled);
  // Sync both toggles
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const dropdownDarkModeToggle = document.getElementById('dropdown-darkmode-toggle');
  if (darkModeToggle) darkModeToggle.checked = enabled;
  if (dropdownDarkModeToggle) dropdownDarkModeToggle.checked = enabled;
}
applyDarkMode();
window.addEventListener('storage', function(e) {
  if (e.key === 'darkMode') applyDarkMode();
});
    // Recent DMs dropdown logic
    const recentDmsBtn = document.getElementById('recent-dms-btn');
    const recentDmsDropdown = document.getElementById('recent-dms-dropdown');
    let recentDmsLoaded = false;
    recentDmsBtn.onclick = async function(e) {
      e.stopPropagation();
      if (recentDmsDropdown.style.display === 'block') {
        recentDmsDropdown.style.display = 'none';
        return;
      }
      recentDmsDropdown.style.display = 'block';
      if (!recentDmsLoaded) {
        recentDmsDropdown.innerHTML = 'Loading...';
        try {
          const res = await fetch('/api/dm?user=all');
          const dms = await res.json();
          if (!dms.length) {
            recentDmsDropdown.innerHTML = '<div style="padding:12px;color:#888;">No DMs yet.</div>';
            return;
          }
          // Group by user
          const userMap = {};
          dms.forEach(dm => {
            const currentUser = dms.currentUser || '';
            const other = dm.from === currentUser ? dm.to : dm.from;
            if (!userMap[other]) userMap[other] = [];
            userMap[other].push(dm);
          });
          recentDmsDropdown.innerHTML = '';
          Object.keys(userMap).forEach(user => {
            const last = userMap[user][userMap[user].length-1];
            const div = document.createElement('div');
            div.className = 'dm-item';
            div.style.padding = '10px 18px';
            div.style.borderBottom = '1px solid #eee';
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.background = '#f4f4f4';
            div.onmouseout = () => div.style.background = '';
            div.onclick = () => { window.location.href = `/dms.html?user=${encodeURIComponent(user)}`; };
            div.innerHTML = `<span style='font-weight:bold;color:#007bff;'>${user}</span><div style='color:#555;font-size:0.97em;margin-top:2px;'>${last.message}</div><div style='color:#aaa;font-size:0.9em;margin-top:2px;'>${new Date(last.time).toLocaleString()}</div>`;
            recentDmsDropdown.appendChild(div);
          });
          recentDmsLoaded = true;
        } catch (err) {
          recentDmsDropdown.innerHTML = '<div style="padding:12px;color:#d00;">Failed to load DMs.</div>';
        }
      } else {
        // Already loaded, just show
        recentDmsDropdown.style.display = 'block';
      }
    };
    // Hide dropdown on outside click
    document.addEventListener('click', function(e) {
      if (recentDmsDropdown.style.display === 'block') recentDmsDropdown.style.display = 'none';
    });
    // Modal logic for settings modal dark mode toggle
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    closeSettings.onclick = () => { settingsModal.style.display = 'none'; };
    settingsModal.onclick = e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; };
    darkModeToggle.onchange = e => {
      localStorage.setItem('darkMode', e.target.checked ? 'true' : 'false');
      applyDarkMode();
    };
    // Avatar dropdown logic
    const navAvatarLink = document.getElementById('nav-avatar-link');
    const avatarDropdown = document.getElementById('avatar-dropdown');
    const dropdownDarkModeToggle = document.getElementById('dropdown-darkmode-toggle');
    const dropdownDarkModeBtn = document.getElementById('dropdown-darkmode-btn');
    const dropdownSettingsBtn = document.getElementById('dropdown-settings-btn');
    const dropdownLogoutBtn = document.getElementById('dropdown-logout-btn');
    const dropdownViewReportsBtn = document.getElementById('dropdown-view-reports-btn');
    // Open/close dropdown
    navAvatarLink.onclick = function(e) {
      e.stopPropagation();
      avatarDropdown.style.display = avatarDropdown.style.display === 'block' ? 'none' : 'block';
      // Sync dark mode toggle
      dropdownDarkModeToggle.checked = document.body.classList.contains('dark-mode');
    };
    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
      if (avatarDropdown.style.display === 'block') avatarDropdown.style.display = 'none';
    });
    // Prevent dropdown from closing when clicking inside
    avatarDropdown.onclick = function(e) { e.stopPropagation(); };
    // Dark mode toggle in dropdown
    dropdownDarkModeToggle.onchange = e => {
      localStorage.setItem('darkMode', e.target.checked ? 'true' : 'false');
      applyDarkMode();
    };
    // Settings button in dropdown
    dropdownSettingsBtn.onclick = function() {
      window.location.href = '/profile-settings.html';
    };
    // Log out button (placeholder)
    dropdownLogoutBtn.onclick = function() {
      // Log out: clear localStorage and redirect to sign-in page
      localStorage.clear();
      window.location.href = '/signin.html';
    };
    // Show 'View Reports' for dev
    if (localStorage.getItem('dev') === '1') {
      dropdownViewReportsBtn.style.display = 'block';
    }
    // View Reports modal logic
    dropdownViewReportsBtn.onclick = function() {
      showReportsModal();
      avatarDropdown.style.display = 'none';
    };
    // Remove unused setDarkMode function
    // Settings button in nav
    const settingsBtn = document.getElementById('settings-btn');
    settingsBtn.onclick = () => { window.location.href = '/profile-settings.html'; };
    // On load, set dark mode if previously enabled
    if (localStorage.getItem('darkMode') === '1') {
      darkModeToggle.checked = true;
      setDarkMode(true);
    }
    // Dark mode styles
    const darkStyle = document.createElement('style');
    darkStyle.textContent = `
      body.dark-mode {
        background: #181a1b !important;
        color: #e0e0e0 !important;
      }
      body.dark-mode nav { background: #111 !important; }
      body.dark-mode .container, body.dark-mode [style*='background:#fff'] {
        background: #23272a !important;
        color: #e0e0e0 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
      }
      body.dark-mode input, body.dark-mode textarea {
        background: #222 !important;
        color: #e0e0e0 !important;
        border-color: #444 !important;
      }
      body.dark-mode button, body.dark-mode [type='submit'] {
        background: #222 !important;
        color: #fff !important;
        border-color: #444 !important;
      }
      body.dark-mode #settings-modal > div {
        background: #23272a !important;
        color: #e0e0e0 !important;
      }
      body.dark-mode .message-bubble {
        background: transparent !important;
        color: #fff !important;
        box-shadow: none !important;
      }
      .message-bubble p {
        color: #222;
      }
      body.dark-mode .message-bubble p {
        color: #fff !important;
      }
    `;
    document.head.appendChild(darkStyle);
    const form = document.getElementById('text-form');
    const statusDiv = document.getElementById('text-status');
    const messagesDiv = document.getElementById('messages');

    let allMessages = [];
    let replyToId = null;

    function renderMessages() {
      messagesDiv.innerHTML = '';
      // Build a map of messages by id
      const msgMap = {};
      allMessages.forEach(m => { msgMap[m.id] = { ...m, replies: [] }; });
      // Build the tree
      allMessages.forEach(m => {
        if (m.parentId && msgMap[m.parentId]) {
          msgMap[m.parentId].replies.push(msgMap[m.id]);
        }
      });
      // Render only root messages
      allMessages.filter(m => !m.parentId).forEach(m => {
        messagesDiv.appendChild(renderMessageNode(msgMap[m.id]));
      });
    }

    // DM menu and modal
    let dmMenu = null;
    let dmModal = null;
    let dmToUser = null;
    function showDmMenu(username, x, y) {
      if (dmMenu) dmMenu.remove();
      dmMenu = document.createElement('div');
      dmMenu.style.position = 'fixed';
      dmMenu.style.left = x + 'px';
      dmMenu.style.top = y + 'px';
      dmMenu.style.background = '#fff';
      dmMenu.style.color = '#222';
      dmMenu.style.border = '1px solid #007bff';
      dmMenu.style.borderRadius = '6px';
      dmMenu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
      dmMenu.style.zIndex = 2000;
      dmMenu.style.padding = '8px 0';
      let html = `<div style='padding:8px 24px;cursor:pointer;' id='dm-send'>Send DM to <b>${username}</b></div>`;
      const isDev = localStorage.getItem('dev') === '1';
      if (isDev && username !== 'dev') {
        html += `<div style='padding:8px 24px;cursor:pointer;color:#a00;' id='dm-suspend'>Suspend <b>${username}</b></div>`;
      }
      dmMenu.innerHTML = html;
      document.body.appendChild(dmMenu);
      document.getElementById('dm-send').onclick = () => {
        window.location.href = `/dms.html?user=${encodeURIComponent(username)}`;
        dmMenu.remove();
      };
      if (isDev && username !== 'dev') {
        document.getElementById('dm-suspend').onclick = () => {
          if (!confirm('Suspend this user?')) return;
          fetch('/api/suspend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          }).then(res => res.json()).then(data => {
            if (data.success) {
              alert('User suspended.');
            } else {
              alert(data.message || 'Failed to suspend user.');
            }
          }).catch(() => alert('Network error.'));
        };
      }
      document.addEventListener('mousedown', hideDmMenu, { once: true });
    }
    function hideDmMenu(e) {
      if (dmMenu) dmMenu.remove();
      dmMenu = null;
    }

    function showDmModal(username) {
      dmToUser = username;
      if (dmModal) dmModal.remove();
      dmModal = document.createElement('div');
      dmModal.style.position = 'fixed';
      dmModal.style.left = 0;
      dmModal.style.top = 0;
      dmModal.style.width = '100vw';
      dmModal.style.height = '100vh';
      dmModal.style.background = 'rgba(0,0,0,0.3)';
      dmModal.style.zIndex = 3000;
      dmModal.style.display = 'flex';
      dmModal.style.alignItems = 'center';
      dmModal.style.justifyContent = 'center';
      dmModal.innerHTML = `
        <div style="background:#fff; color:#222; padding:32px; border-radius:8px; min-width:320px; max-width:90vw; box-shadow:0 2px 16px rgba(0,0,0,0.2); position:relative;">
          <button id="close-dm-modal" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.3em; cursor:pointer;">‚úñÔ∏è</button>
          <h2 style="margin-top:0;">DM with <span id="dm-username"></span></h2>
          <div id="dm-messages" style="max-height:200px; overflow-y:auto; background:#f4f4f4; padding:12px; border-radius:6px; margin-bottom:12px;"></div>
          <form id="dm-form">
            <textarea id="dm-message" rows="2" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;"></textarea>
            <button type="submit" style="margin-top:8px; width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:4px; font-size:15px; cursor:pointer;">Send</button>
            <div id="dm-status" style="margin-top:8px; color:#007bff; text-align:center;"></div>
          </form>
        </div>
      `;
      document.body.appendChild(dmModal);
      document.getElementById('close-dm-modal').onclick = () => { dmModal.remove(); dmModal = null; };
      document.getElementById('dm-username').textContent = username;
      fetchDmMessages(username);
      document.getElementById('dm-form').onsubmit = async function(e) {
        e.preventDefault();
        const msg = document.getElementById('dm-message').value.trim();
        if (!msg) return;
        document.getElementById('dm-status').textContent = 'Sending...';
        try {
          const res = await fetch('/api/dm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to: username, message: msg })
          });
          const data = await res.json();
          if (data.success) {
            document.getElementById('dm-status').textContent = 'Sent!';
            document.getElementById('dm-form').reset();
            await fetchDmMessages(username);
          } else {
            document.getElementById('dm-status').textContent = data.message || 'Failed to send.';
          }
        } catch (err) {
          document.getElementById('dm-status').textContent = 'Network error.';
        }
      };
      document.getElementById('dm-message').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('dm-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      });
    }

    async function fetchDmMessages(username) {
      const dmMessagesDiv = document.getElementById('dm-messages');
      dmMessagesDiv.innerHTML = 'Loading...';
      try {
        const res = await fetch('/api/dm?user=' + encodeURIComponent(username));
        const data = await res.json();
        dmMessagesDiv.innerHTML = '';
        data.forEach(dm => {
          const p = document.createElement('p');
          p.textContent = `[${new Date(dm.time).toLocaleTimeString()}] ${dm.from}: ${dm.message}`;
          p.style.margin = '6px 0';
          p.style.color = dm.from === username ? '#007bff' : '#333';
          dmMessagesDiv.appendChild(p);
        });
        dmMessagesDiv.scrollTop = dmMessagesDiv.scrollHeight;
      } catch (err) {
        dmMessagesDiv.innerHTML = '<span style="color:#d00">Failed to load DMs.</span>';
      }
    }

    function renderMessageNode(msg) {
      const div = document.createElement('div');
      div.style.margin = '6px 0 6px 0';
      div.style.paddingLeft = msg.parentId ? '24px' : '0';
      div.className = 'message-bubble';
      const p = document.createElement('p');
      // Username and message, timestamp on hover
      const userSpan = document.createElement('span');
      userSpan.textContent = msg.username ? msg.username : 'Anonymous';
      userSpan.style.fontWeight = 'bold';
      userSpan.style.color = '#007bff';
      userSpan.style.marginRight = '8px';
      userSpan.style.cursor = 'pointer';
      userSpan.onclick = e => {
        e.stopPropagation();
        // Always go to DM screen directly for reliability
        window.location.href = `/dms.html?user=${encodeURIComponent(msg.username)}`;
      };
      p.appendChild(userSpan);
      const msgSpan = document.createElement('span');
      msgSpan.textContent = msg.message;
      p.appendChild(msgSpan);
      p.title = new Date(msg.time).toLocaleString();
      p.style.color = '#222';
      if (document.body.classList.contains('dark-mode')) {
        p.style.color = '#fff';
      }
      p.style.margin = '0';
      div.appendChild(p);
      // Reply button
      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.style.margin = '2px 0 0 8px';
      replyBtn.style.fontSize = '0.9em';
      replyBtn.style.padding = '2px 8px';
      replyBtn.style.borderRadius = '4px';
      replyBtn.style.border = '1px solid #007bff';
      replyBtn.style.background = '#fff';
      replyBtn.style.color = '#007bff';
      replyBtn.style.cursor = 'pointer';
      replyBtn.onclick = () => {
        replyToId = msg.id;
        document.getElementById('message').focus();
        statusDiv.textContent = `Replying to message #${msg.id}`;
      };
      div.appendChild(replyBtn);

      // Report button
      const reportBtn = document.createElement('button');
      reportBtn.textContent = 'Report';
      reportBtn.style.margin = '2px 0 0 8px';
      reportBtn.style.fontSize = '0.9em';
      reportBtn.style.padding = '2px 8px';
      reportBtn.style.borderRadius = '4px';
      reportBtn.style.border = '1px solid #d00';
      reportBtn.style.background = '#fff';
      reportBtn.style.color = '#d00';
      reportBtn.style.cursor = 'pointer';
      reportBtn.onclick = () => {
        const reason = prompt('Enter reason for reporting this user:');
        if (!reason) return;
        fetch('/api/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: msg.username, reason })
        }).then(res => res.json()).then(data => {
          if (data.success) {
            alert('User reported.');
          } else {
            alert(data.message || 'Failed to report user.');
          }
        }).catch(() => alert('Network error.'));
      };
      div.appendChild(reportBtn);

      // Suspend button for dev accounts
      const isDev = localStorage.getItem('dev') === '1';
      if (isDev) {
        const suspendBtn = document.createElement('button');
        suspendBtn.textContent = 'Suspend';
        suspendBtn.style.margin = '2px 0 0 8px';
        suspendBtn.style.fontSize = '0.9em';
        suspendBtn.style.padding = '2px 8px';
        suspendBtn.style.borderRadius = '4px';
        suspendBtn.style.border = '1px solid #a00';
        suspendBtn.style.background = '#fff';
        suspendBtn.style.color = '#a00';
        suspendBtn.style.cursor = 'pointer';
        suspendBtn.onclick = () => {
          if (!confirm('Suspend this user?')) return;
          fetch('/api/suspend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: msg.username })
          }).then(res => res.json()).then(data => {
            if (data.success) {
              alert('User suspended.');
            } else {
              alert(data.message || 'Failed to suspend user.');
            }
          }).catch(() => alert('Network error.'));
        };
        div.appendChild(suspendBtn);
      }
      // Render replies
      if (msg.replies && msg.replies.length) {
        msg.replies.forEach(r => div.appendChild(renderMessageNode(r)));
      }
      return div;
    }

    async function fetchMessages() {
      try {
        const res = await fetch('/api/messages');
        allMessages = await res.json();
        renderMessages();
      } catch (err) {
        messagesDiv.innerHTML = '<span style="color:#d00">Failed to load messages.</span>';
      }
    }

    // Show/hide text box
    const openTextBoxBtn = document.getElementById('open-text-box');
    openTextBoxBtn.addEventListener('click', function() {
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        document.getElementById('message').focus();
      }
    });

    // Submit on Enter (without Shift)
    document.getElementById('message').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
      }
    });

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const msg = document.getElementById('message').value.trim();
      if (!msg) {
        statusDiv.textContent = 'Please enter a message.';
        return;
      }
      statusDiv.textContent = 'Sending...';
      try {
        const res = await fetch('/api/text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(replyToId ? { message: msg, parentId: replyToId } : { message: msg })
        });
        const data = await res.json();
        if (data.success) {
          statusDiv.textContent = 'Message sent!';
          form.reset();
          replyToId = null;
          await fetchMessages();
        } else {
          statusDiv.textContent = data.message || 'Failed to send.';
        }
      } catch (err) {
        statusDiv.textContent = 'Network error.';
      }
    });

    // Poll for new messages every 2 seconds
    setInterval(fetchMessages, 2000);
    fetchMessages();
    // Reports modal for devs
    function showReportsModal() {
      let modal = document.getElementById('reports-modal');
      if (modal) modal.remove();
      modal = document.createElement('div');
      modal.id = 'reports-modal';
      modal.style.position = 'fixed';
      modal.style.left = 0;
      modal.style.top = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.3)';
      modal.style.zIndex = 4000;
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.innerHTML = `
        <div style="background:#fff; color:#222; padding:32px; border-radius:8px; min-width:340px; max-width:95vw; max-height:80vh; overflow-y:auto; box-shadow:0 2px 16px rgba(0,0,0,0.2); position:relative;">
          <button id="close-reports-modal" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.3em; cursor:pointer;">‚úñÔ∏è</button>
          <h2 style="margin-top:0;">User Reports</h2>
          <div id="reports-list">Loading...</div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('close-reports-modal').onclick = () => { modal.remove(); };
      fetch('/data/reports.json').then(r => r.json()).then(reports => {
        const list = document.getElementById('reports-list');
        if (!reports.length) { list.textContent = 'No reports.'; return; }
        list.innerHTML = '';
        reports.reverse().forEach(rep => {
          const div = document.createElement('div');
          div.style.borderBottom = '1px solid #eee';
          div.style.padding = '8px 0';
          div.innerHTML = `<b>${rep.reported}</b> reported by <b>${rep.from}</b><br><span style='color:#555'>${rep.reason}</span><br><span style='font-size:0.9em;color:#888'>${new Date(rep.time).toLocaleString()}</span>`;
          // Suspend button
          const suspendBtn = document.createElement('button');
          suspendBtn.textContent = 'Suspend';
          suspendBtn.style.margin = '4px 0 0 8px';
          suspendBtn.style.fontSize = '0.9em';
          suspendBtn.style.padding = '2px 8px';
          suspendBtn.style.borderRadius = '4px';
          suspendBtn.style.border = '1px solid #a00';
          suspendBtn.style.background = '#fff';
          suspendBtn.style.color = '#a00';
          suspendBtn.style.cursor = 'pointer';
          suspendBtn.onclick = () => {
            if (!confirm('Suspend this user?')) return;
            fetch('/api/suspend', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: rep.reported })
            }).then(res => res.json()).then(data => {
              if (data.success) {
                alert('User suspended.');
              } else {
                alert(data.message || 'Failed to suspend user.');
              }
            }).catch(() => alert('Network error.'));
          };
          div.appendChild(suspendBtn);
          list.appendChild(div);
        });
      }).catch(() => {
        document.getElementById('reports-list').textContent = 'Failed to load reports.';
      });
    }
  </script>
</body>
</html>
